<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catatan Saya — FastAPI</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <h1>📘 Catatan Saya</h1>

      <div class="controls">
        <input id="searchInput" type="text" placeholder="🔍 Cari catatan..." />
        <button id="toggleTheme" type="button">🌙</button>
      </div>
    </div>

    <div style="text-align: right; margin: 10px 0;">
      <a href="/download_csv"><button class="download-csv">💾 Unduh CSV</button></a>
    </div>

    <form action="/add" method="post" class="add-form">
      <input name="content" type="text" placeholder="Tulis catatan baru..." required />
      <button type="submit">Tambah</button>
    </form>

    <div id="notes" class="notes">
      {% for note in notes %}
      <div class="note" data-note-id="{{ note.id }}">
        <p>{{ note.content }}</p>
        
        <small style="color: gray; font-size: 0.8em;">🕒 {{ note.created_local }}</small>

        <div class="actions">
          <form action="/delete/{{ note.id }}" method="post" style="display:inline;">
            <button type="submit" class="delete">❌</button>
          </form>

          <!-- aman: data-content menggunakan filter |e -->
          <button type="button" class="edit" data-content="{{ note.content | e }}"
            onclick="showEditForm({{ note.id }}, this.dataset.content)">✏️</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- EDIT FORM (ganti bagian editForm di file kamu dengan ini) -->
    <div id="editForm" class="edit-form" style="display:none;">
      <h3>Edit Catatan</h3>
      <form id="editFormInner" method="post">
        <input type="hidden" id="editId" name="id" />
        <input type="text" id="editContent" name="content" required />
        <div style="margin-top:10px;">
          <button type="submit">Simpan</button>
          <button type="button" id="cancelEditBtn">Batal</button>
        </div>
      </form>
    </div>

    <script>
      // Tampilkan form edit dengan isi
      function showEditForm(id, content) {
        document.getElementById("editForm").style.display = "block";
        document.getElementById("editId").value = id;
        document.getElementById("editContent").value = content;
        // fokus ke input agar user langsung bisa mengetik
        document.getElementById("editContent").focus();
      }

      // Sembunyikan form edit dan kosongkan field
      function hideEditForm() {
        const editForm = document.getElementById("editForm");
        if (!editForm) return;
        editForm.style.display = "none";
        document.getElementById("editId").value = "";
        document.getElementById("editContent").value = "";
      }

      // Submit edit via fetch then reload
      document.getElementById("editFormInner").onsubmit = function (e) {
        e.preventDefault();
        let id = document.getElementById("editId").value;
        let content = document.getElementById("editContent").value;
        fetch(`/edit/${id}`, {
          method: "POST",
          body: new URLSearchParams({ content })
        }).then(() => window.location.reload());
      };

      // Tombol batal
      document.getElementById("cancelEditBtn").addEventListener("click", function () {
        hideEditForm();
      });

      // Close edit form if click di luar (tetap ada)
      document.addEventListener("click", (e) => {
        const editForm = document.getElementById("editForm");
        if (!editForm) return;
        // jika edit form terbuka dan klik di luar form dan bukan tombol edit, sembunyikan
        if (editForm.style.display === "block" && !editForm.contains(e.target) && !e.target.classList.contains("edit")) {
          hideEditForm();
        }
      });

      // Escape key untuk batal
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          const editForm = document.getElementById("editForm");
          if (editForm && editForm.style.display === "block") {
            hideEditForm();
          }
        }
      });

      // Live search & theme code tetap (jika sudah ada di file), jangan hapus
    </script>
    

    <!-- <div id="editForm" class="edit-form" style="display:none;">
      <h3>Edit Catatan</h3>
      <form id="editFormInner" method="post">
        <input type="hidden" id="editId" name="id" />
        <input type="text" id="editContent" name="content" required />
        <button type="submit">Simpan</button>
      </form>
    </div> -->


  </div>

  <script>
    // EDIT modal
    function showEditForm(id, content) {
      document.getElementById("editForm").style.display = "block";
      document.getElementById("editId").value = id;
      document.getElementById("editContent").value = content;
    }

    // Submit edit via fetch then reload
    document.getElementById("editFormInner").onsubmit = function (e) {
      e.preventDefault();
      let id = document.getElementById("editId").value;
      let content = document.getElementById("editContent").value;
      fetch(`/edit/${id}`, {
        method: "POST",
        body: new URLSearchParams({ content })
      }).then(() => window.location.reload());
    };

    // Live search
    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("input", function () {
      const q = searchInput.value.toLowerCase();
      document.querySelectorAll(".note").forEach(noteEl => {
        const text = noteEl.querySelector("p").textContent.toLowerCase();
        noteEl.style.display = text.includes(q) ? "flex" : "none";
      });
    });

    // Dark mode toggle (persists per session via localStorage)
    const toggleBtn = document.getElementById("toggleTheme");
    const current = localStorage.getItem("theme");
    if (current === "dark") document.body.classList.add("dark"), toggleBtn.textContent = "☀️";

    toggleBtn.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark");
      toggleBtn.textContent = isDark ? "☀️" : "🌙";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    // close edit form if click outside
    document.addEventListener("click", (e) => {
      const editForm = document.getElementById("editForm");
      if (!editForm) return;
      // jika edit form terbuka dan klik di luar form, sembunyikan
      if (editForm.style.display === "block" && !editForm.contains(e.target) && !e.target.classList.contains("edit")) {
        editForm.style.display = "none";
      }
    });
  </script>
</body>
</html>




<!-- <!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>📝 Catatan Saya</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <h1>📘 Catatan Saya</h1>

            <div style="text-align: right; margin-bottom: 10px;">
                <a href="/download">
                    <button type="button" style="
                        background-color: #3f51b5;
                        color: white;
                        border: none;
                        padding: 8px 14px;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: 0.3s;
                    ">💾 Unduh Semua Catatan</button>
                </a>
            </div>

            <div class="controls">
                <input type="text" id="searchInput" placeholder="🔍 Cari catatan...">
                <button id="toggleTheme">🌙</button>
            </div>
        </div>

        <form action="/add" method="post" class="add-form">
            <input type="text" name="content" placeholder="Tulis catatan baru..." required>
            <button type="submit">Tambah</button>
        </form>

        <div id="notes" class="notes">
            {% for note in notes %}
            <div class="note">
                <p>{{ note.content }}</p>
                <div class="actions">
                    <form action="/delete/{{ note.id }}" method="post" style="display:inline;">
                        <button type="submit" class="delete">❌</button>
                    </form>
                    <button type="button" class="edit" onclick="showEditForm({{ note.id }}, '{{ note.content | replace("'", "&#39;") }}')">✏️</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="editForm" class="edit-form" style="display:none;">
            <h3>Edit Catatan</h3>
            <form id="editFormInner" method="post">
                <input type="hidden" id="editId" name="id">
                <input type="text" id="editContent" name="content" required>
                <button type="submit">Simpan</button>
            </form>
        </div>
    </div>

    <script>
        // 🟣 FUNGSI EDIT
        function showEditForm(id, content) {
            document.getElementById("editForm").style.display = "block";
            document.getElementById("editId").value = id;
            document.getElementById("editContent").value = content;
        }

        document.getElementById("editFormInner").onsubmit = function(e) {
            e.preventDefault();
            let id = document.getElementById("editId").value;
            let content = document.getElementById("editContent").value;
            fetch(`/edit/${id}`, {
                method: "POST",
                body: new URLSearchParams({ content })
            }).then(() => window.location.reload());
        };

        // 🔍 FITUR PENCARIAN
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", function() {
            const filter = searchInput.value.toLowerCase();
            const notes = document.querySelectorAll(".note");
            notes.forEach(note => {
                const text = note.querySelector("p").textContent.toLowerCase();
                note.style.display = text.includes(filter) ? "flex" : "none";
            });
        });

        // 🌙 DARK MODE TOGGLE
        const toggleBtn = document.getElementById("toggleTheme");
        toggleBtn.addEventListener("click", () => {
            document.body.classList.toggle("dark");
            toggleBtn.textContent = document.body.classList.contains("dark") ? "☀️" : "🌙";
        });
    </script>
</body>
</html> -->
